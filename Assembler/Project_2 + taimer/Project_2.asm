/*
MK:	ATtiny2313
Тактовая частота:	1 MHz
*/

.include "tn2313def.inc"    //Файл описания

.def	ON	=R16		// Регистру R16 присвоили имя temp
.def	temp	=R17
.def	OFF	=R20
.def	tempstack	=R21
.def	temptm	=R22
.def	Delay = R18			// Задержка
.def	loop = R19			// Петля задержки
.equ	allON	=0xFF		//Константа везде единицы

.equ	DelayMax = 0xFF		//Длительность петли

.org	0x00
		
		
		rjmp	init	
		reti			;(0;01) ??????? ?????????? 0
		reti			;(0;02) ??????? ?????????? 1
		reti			;(0;03) ?????? ???????/???????? ?1
		reti		    ;(0;04) ?????????? ? ???????/???????? ?1
		reti			;(0;05) ???????????? ???????/???????? ?1
		rjmp	T0_Ovr	;(0;06) ???????????? ???????/???????? ?0
		reti			;(0;07) USART, ????? ????????
		reti			;(0;08) ??????? ?????? USART ????
		reti			;(0;09) USART, ???????? ?????????
		reti			;(0;0A) ?????????? ?? ???????????
		reti			;(0;0B) ?????????? ?? ????????? ?? ????? ????????
		reti			;(0;0C) ?????????? ? ???????/???????? ?1
		reti			;(0;0D) ?????????? ? ???????/???????? ?0
		reti			;(0;0E) ?????????? ? ???????/???????? ?0
		reti			;(0;0F) USI ????????? ??????????
		reti			;(0;10) USI ????????????
		reti			;(0;11) EEPROM ??????????
		reti			;(0;12) ???????????? ??????????? ??????

init:	

 		ldi	tempstack, low (RAMEND)		//Инициализация стека
		out	SPL, tempstack

	
		ldi	ON,allON	//В регистр R16 загрузили константу 
		ldi OFF,0x20
		out	DDRB,ON		//ПОРт В на выход
		out	DDRD,ON		
		clr	temp			//Обнулили регистр
		/*
		Регистр TIMSK разрешает/запрещает различные прерывания для таймеров Т0 и Т1 
		Описание регистра TIMSK на 227 странице
		Если разряды сброшены в ноль, то соответствующие этим разрядам прерывания, запрещены

		Для таймера Т0:
		TOIE0 	Прерывание по переполнению таймера Т0 
				Переполнение - когда счетный регистр таймера переходит с 255 на 0

		OCIE0A	Прерывание по совпадению счетного регистра TCNT0 таймера Т0	с регистром совпадения OCR0A

		OCIE0B	Прерывание по совпадению счетного регистра TCNT0 таймера Т0	с регистром совпадения OCR0B
		*/
		
		ldi tempstack, (1<<TOIE0)		;Прерывания по переполнению
		out TIMSK, tempstack


		ldi		tempstack,(1<CS02|0<<CS01|1<CS00) ;деление 1
		out		TCCR0B,tempstack
		

		sei		;ГЛОБАЛЬНОЕ РАЗРЕШЕНИЕ ПРЕРЫВАНИЙ
main:
		out	PORTB, ON		;Включили VD
		out PORTD, ON
		rcall	Pause		//вызов задержки
		rcall	Pause		//вызов задержки
		nop
	/*_______________________________________________________________________*/
		
		out PORTB, temp
		out PORTD, OFF		//ВЫключили VD	
		rcall	Pause		//вызов задержки
		rcall	Pause		//вызов задержки
		nop
	
	
	/*_______________________________________________________________________*/
	//	Включение и выключение последнего диода
	/*
		out PORTD, temp 
		rcall	Pause
		rcall	Pause		//вызов задержки
	
		out PORTD, OFF		//ВЫключили VD
		rcall	Pause
		rcall	Pause		//вызов задержки
		
	*/	
		

	
;Если забыть установить командой sei бит I, то прерывания происходить не будут




		/*_______________________________________________________________________*/
		rjmp main


T0_Ovr:
		
		cbi PORTD, 5
		rcall	Pause
		sbi PORTD, 5		//ВЫключили VD
		
		rcall	Pause		//вызов задержки
		
		reti				;Завершаем прерывание

Pause:
	
	ldi loop, DelayMax
P1:	ldi Delay,DelayMax
P2:	dec	Delay	
	nop
	nop
	brne P2
	dec	loop
	brne P1
	ret


		
